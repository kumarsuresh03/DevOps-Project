name: Frontend CI/CD (Manual)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment (dev/stage/prod)"
        required: true
        default: "dev"

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    env:
      AWS_REGION: ap-south-1
      ACCOUNT_ID: 375864262524
      ENV: ${{ github.event.inputs.environment }}
      S3_BUCKET: myapp-frontend-${{ github.event.inputs.environment }}-375864262524

    steps:
      # ðŸ”¹ Checkout Code
      - name: Checkout Code
        uses: actions/checkout@v4

      # ðŸ”¹ Select Environment Variables Dynamically
      - name: Set Environment Variables
        run: |
          if [ "${ENV}" = "dev" ]; then
            echo "DISTRIBUTION_ID=${{ vars.CLOUDFRONT_DEV_ID }}" >> $GITHUB_ENV
            echo "NEXT_PUBLIC_API_URL=${{ vars.FRONTEND_DEV_API_URL }}" >> $GITHUB_ENV
          elif [ "${ENV}" = "stage" ]; then
            echo "DISTRIBUTION_ID=${{ vars.CLOUDFRONT_STAGE_ID }}" >> $GITHUB_ENV
            echo "NEXT_PUBLIC_API_URL=${{ vars.FRONTEND_STAGE_API_URL }}" >> $GITHUB_ENV
          elif [ "${ENV}" = "prod" ]; then
            echo "DISTRIBUTION_ID=${{ vars.CLOUDFRONT_PROD_ID }}" >> $GITHUB_ENV
            echo "NEXT_PUBLIC_API_URL=${{ vars.FRONTEND_PROD_API_URL }}" >> $GITHUB_ENV
          fi

      # ðŸ”¹ Configure AWS Credentials
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # ðŸ”¹ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # ðŸ”¹ Install Dependencies
      - name: Install Dependencies
        run: |
          cd frontend
          npm install

      # ðŸ”¹ Build Static Site
      - name: Build Static Site
        run: |
          cd frontend
          echo "NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL" > .env.production
          npm run build

      # ðŸ”¹ Upload to S3
      - name: Upload to S3
        run: |
          aws s3 sync frontend/out/ s3://$S3_BUCKET --delete

      # ðŸ”¹ Invalidate CloudFront Cache
      - name: Invalidate CloudFront Cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id $DISTRIBUTION_ID \
            --paths "/*"
