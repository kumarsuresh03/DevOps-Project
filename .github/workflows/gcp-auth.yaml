name: Frontend CI/CD (GCP Manual)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment (dev/stage/prod)"
        required: true
        default: "dev"

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    env:
      PROJECT_ID: dev-stage-project
      ENV: ${{ github.event.inputs.environment }}

    steps:
      # ðŸ”¹ Checkout Code
      - name: Checkout Code
        uses: actions/checkout@v4

      # ðŸ”¹ Authenticate to GCP using OIDC
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: "projects/393888714848/locations/global/workloadIdentityPools/github-pool/providers/github-provider"
          service_account: "terraform-sa@dev-stage-project.iam.gserviceaccount.com"

      # ðŸ”¹ Setup gcloud
      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Set GCP Project
        run: gcloud config set project $PROJECT_ID

      # ðŸ”¹ Select Bucket + API URL Dynamically
      - name: Set Environment Variables
        run: |
          if [ "${ENV}" = "dev" ]; then
            echo "BUCKET_NAME=dev-stage-frontend-bucket" >> $GITHUB_ENV
            echo "NEXT_PUBLIC_API_URL=${{ vars.FRONTEND_DEV_API_URL }}" >> $GITHUB_ENV
          elif [ "${ENV}" = "stage" ]; then
            echo "BUCKET_NAME=stage-frontend-bucket" >> $GITHUB_ENV
            echo "NEXT_PUBLIC_API_URL=${{ vars.FRONTEND_STAGE_API_URL }}" >> $GITHUB_ENV
          elif [ "${ENV}" = "prod" ]; then
            echo "BUCKET_NAME=prod-frontend-bucket" >> $GITHUB_ENV
            echo "NEXT_PUBLIC_API_URL=${{ vars.FRONTEND_PROD_API_URL }}" >> $GITHUB_ENV
          fi

      # ðŸ”¹ Setup Node
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # ðŸ”¹ Install Dependencies
      - name: Install Dependencies
        run: |
          cd frontend
          npm install

      # ðŸ”¹ Build Static Site
      - name: Build Static Site
        run: |
          cd frontend
          echo "NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL" > .env.production
          npm run build

      # ðŸ”¹ Upload to GCS
      - name: Upload to GCS
        run: |
          gsutil -m rsync -r frontend/out gs://$BUCKET_NAME

      # ðŸ”¹ Invalidate Cloud CDN Cache
      - name: Invalidate Cloud CDN
        run: |
          gcloud compute url-maps invalidate-cdn-cache frontend-url-map \
            --path "/*"
