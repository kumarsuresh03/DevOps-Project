name: Build Push and Update Cloud Run

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      PROJECT_ID: dev-stage-project
      REGION: asia-south1
      SERVICE_NAME: dev-backend-app

    steps:
      # ðŸ”¹ Checkout Code
      - name: Checkout Code
        uses: actions/checkout@v4

      # ðŸ”¹ Authenticate to GCP (OIDC)
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: "projects/393888714848/locations/global/workloadIdentityPools/github-pool/providers/github-provider"
          service_account: "terraform-sa@dev-stage-project.iam.gserviceaccount.com"

      # ðŸ”¹ Setup gcloud
      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      # ðŸ”¹ Configure Docker Authentication
      - name: Configure Docker
        run: |
          gcloud auth configure-docker asia-south1-docker.pkg.dev --quiet

      # ðŸ”¹ Build Docker Image (Unique Tag Every Time)
      - name: Build Docker Image
        run: |
          IMAGE_URI=asia-south1-docker.pkg.dev/$PROJECT_ID/dev-repo/backend-app:${GITHUB_SHA}
          docker build -t $IMAGE_URI ./backend
          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV

      # ðŸ”¹ Push Docker Image
      - name: Push Docker Image
        run: |
          docker push $IMAGE_URI

      # ðŸ”¹ Update Cloud Run Image Only
      - name: Update Cloud Run Image
        run: |
          gcloud run services update $SERVICE_NAME \
            --image $IMAGE_URI \
            --region $REGION

      # ðŸ”¹ Show Service URL
      - name: Show Service URL
        run: |
          gcloud run services describe $SERVICE_NAME \
            --region $REGION \
            --format='value(status.url)'
