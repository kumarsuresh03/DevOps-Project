name: Build and Push Image

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment (dev/stage/prod)"
        required: true
        default: "dev"

permissions:
  id-token: write
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    env:
      PROJECT_ID: dev-stage-project
      REGION: asia-south1
      ENV: ${{ github.event.inputs.environment }}

    steps:
      # ðŸ”¹ Checkout Code
      - name: Checkout Code
        uses: actions/checkout@v4

      # ðŸ”¹ Authenticate to GCP (OIDC)
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: "projects/393888714848/locations/global/workloadIdentityPools/github-pool/providers/github-provider"
          service_account: "terraform-sa@dev-stage-project.iam.gserviceaccount.com"

      # ðŸ”¹ Setup gcloud
      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      # ðŸ”¹ Configure Docker Authentication
      - name: Configure Docker
        run: |
          gcloud auth configure-docker $REGION-docker.pkg.dev --quiet

      # ðŸ”¹ Set Repo Based on ENV
      - name: Set Repository Name
        run: |
          if [[ "$ENV" == "dev" ]]; then
            echo "REPO_NAME=dev-repo" >> $GITHUB_ENV
          elif [[ "$ENV" == "stage" ]]; then
            echo "REPO_NAME=stage-repo" >> $GITHUB_ENV
          elif [[ "$ENV" == "prod" ]]; then
            echo "REPO_NAME=prod-repo" >> $GITHUB_ENV
          fi

      # ðŸ”¹ Build Docker Image
      - name: Build Docker Image
        run: |
          IMAGE_URI=$REGION-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/backend-app:$ENV
          docker build -t $IMAGE_URI ./backend
          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV

      # ðŸ”¹ Push Docker Image
      - name: Push Docker Image
        run: |
          docker push $IMAGE_URI
          echo "Image pushed successfully: $IMAGE_URI"
